name: Documentation Quality

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  schedule:
    # run at 9:00 am utc every monday
    - cron: '0 9 * * 1'

permissions:
  contents: read
  checks: write
  pull-requests: write
  issues: write

jobs:
  markdown-lint:
    name: markdown linting
    runs-on: ubuntu-latest

    steps:
    - name: checkout code
      uses: actions/checkout@v5

    - name: run markdownlint
      uses: DavidAnson/markdownlint-cli2-action@v18
      with:
        globs: '**/*.md'
      continue-on-error: true

  link-check:
    name: link validation
    runs-on: ubuntu-latest

    steps:
    - name: checkout code
      uses: actions/checkout@v5

    - name: check markdown links
      uses: gaurav-nelson/github-action-markdown-link-check@v1
      with:
        use-quiet-mode: 'yes'
        use-verbose-mode: 'yes'
        config-file: '.github/markdown-link-check-config.json'
        check-modified-files-only: 'no'
      continue-on-error: true

  spell-check:
    name: spell checking
    runs-on: ubuntu-latest

    steps:
    - name: checkout code
      uses: actions/checkout@v5

    - name: run cspell
      uses: streetsidesoftware/cspell-action@v8
      with:
        files: '**/*.md'
        incremental_files_only: false
      continue-on-error: true

  build-verification:
    name: verify docsify build
    runs-on: ubuntu-latest

    steps:
    - name: checkout code
      uses: actions/checkout@v5

    - name: setup node.js
      uses: actions/setup-node@v6
      with:
        node-version: '22'
        cache: 'npm'

    - name: install dependencies
      run: npm ci

    - name: verify docsify can serve
      run: |
        timeout 30s npm run serve &
        sleep 10
        curl -f http://localhost:3000 || exit 1
        echo "âœ… Docsify server started successfully"

  security-scan:
    name: dependency security scan
    runs-on: ubuntu-latest

    steps:
    - name: checkout code
      uses: actions/checkout@v5

    - name: setup node.js
      uses: actions/setup-node@v6
      with:
        node-version: '22'
        cache: 'npm'

    - name: run npm audit
      run: npm audit --json > npm-audit.json || true
      continue-on-error: true

    - name: upload audit results
      if: always()
      uses: actions/upload-artifact@v5
      with:
        name: npm-audit-report
        path: npm-audit.json
        retention-days: 7

  quality-gate:
    name: quality gate
    runs-on: ubuntu-latest
    needs: [ markdown-lint, link-check, build-verification ]
    if: always()

    steps:
    - name: check quality gate status
      run: |
        echo "## ðŸ” Documentation Quality Summary" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "| Check | Status |" >> $GITHUB_STEP_SUMMARY
        echo "|-------|--------|" >> $GITHUB_STEP_SUMMARY
        echo "| Markdown Lint | ${{ needs.markdown-lint.result == 'success' && 'âœ…' || 'âš ï¸' }} |" >> $GITHUB_STEP_SUMMARY
        echo "| Link Check | ${{ needs.link-check.result == 'success' && 'âœ…' || 'âš ï¸' }} |" >> $GITHUB_STEP_SUMMARY
        echo "| Build Verification | ${{ needs.build-verification.result == 'success' && 'âœ…' || 'âŒ' }} |" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY

        if [[ "${{ needs.build-verification.result }}" == "failure" ]]; then
          echo "âŒ **Quality Gate Failed:** Build verification must pass" >> $GITHUB_STEP_SUMMARY
          exit 1
        else
          echo "âœ… **Quality Gate Passed**" >> $GITHUB_STEP_SUMMARY
        fi
